<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fruit Counter</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .container { display: flex; gap: 20px; margin-bottom: 20px; }
        .video-box { flex: 1; }
        #liveFeed { max-width: 100%; border: 2px solid #333; }
        .result-box { background: #f9f9f9; padding: 15px; margin: 10px 0; }
        .history { margin-top: 30px; }
        .processing { color: blue; }
        .error { color: red; }
        #stopBtn { background-color: #ff4444; color: white; border: none; padding: 5px 10px; cursor: pointer; }
        .comparison { display: flex; gap: 20px; }
        .comparison-item { flex: 1; }
    </style>
</head>
<body>
    <h1>–ü–æ–¥—Å—á—ë—Ç —Ñ—Ä—É–∫—Ç–æ–≤</h1>

    <form method="post" action="/upload" enctype="multipart/form-data">
        <input type="file" name="file" accept="image/*, video/*" required>
        <button type="submit">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
        {% if is_processing %}
            <button type="button" id="stopBtn">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É</button>
        {% endif %}
    </form>

    {% if input_file %}
        <div class="container">
            <div class="video-box">
                <h2>–ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª</h2>
                {% if input_file.lower().endswith(('.mp4', '.avi', '.mov')) %}
                    <video controls width="100%">
                        <source src="{{ input_file }}" type="video/mp4">
                    </video>
                {% else %}
                    <img src="{{ input_file }}" alt="Input Image" width="100%">
                {% endif %}
            </div>

            {% if is_video %}
                <div class="video-box">
                    <h2>–î–µ—Ç–µ–∫—Ü–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h2>
                    <img id="liveFeed" src="{{ url_for('video_feed') }}">
                    {% if is_processing %}
                        <p class="processing">–ò–¥—ë—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ...</p>
                    {% endif %}
                </div>
            {% elif processed_file %}
                <div class="video-box">
                    <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏</h2>
                    <img src="{{ processed_file }}" alt="Processed Image" width="100%">
                </div>
            {% endif %}
        </div>

        {% if result and not is_video %}
            <div class="result-box">
                <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
                <p>üçé –Ø–±–ª–æ–∫–∏: {{ result.apple }}</p>
                <p>üçå –ë–∞–Ω–∞–Ω—ã: {{ result.banana }}</p>
                <p>üçä –ê–ø–µ–ª—å—Å–∏–Ω—ã: {{ result.orange }}</p>
            </div>
        {% elif is_video and not is_processing %}
            <div class="result-box">
                <h2>–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h2>
                <a href="/download_report/report_{{ input_file.split('/')[-1] }}.xlsx">
                    –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç (Excel)
                </a>
                <p>–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤: static/processed/{{ current_video }}</p>
            </div>
        {% endif %}
    {% endif %}

    <div class="history">
        <h2>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤</h2>
        <table>
            <tr>
                <th>–î–∞—Ç–∞</th>
                <th>–¢–∏–ø —Ñ–∞–π–ª–∞</th>
                <th>–§–∞–π–ª</th>
                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
            </tr>
            {% for entry in history %}
                <tr>
                    <td>{{ entry.timestamp }}</td>
                    <td>{{ entry.file_type }}</td>
                    <td>
                        {% if entry.file_type == "image" %}
                            <a href="static/processed/{{ entry.filename }}" target="_blank">{{ entry.filename }}</a>
                        {% else %}
                            <a href="static/processed/{{ entry.filename }}" target="_blank">{{ entry.filename }}</a>
                        {% endif %}
                    </td>
                    <td>
                        {% if entry.file_type == "image" %}
                            üçé {{ entry.detections.apple }}
                            üçå {{ entry.detections.banana }}
                            üçä {{ entry.detections.orange }}
                        {% else %}
                            <a href="/download_report/report_{{ entry.filename }}.xlsx">–û—Ç—á—ë—Ç</a>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </table>
    </div>

    <script>
        const liveFeed = document.getElementById('liveFeed');
        if (liveFeed) {
            setInterval(() => {
                liveFeed.src = "{{ url_for('video_feed') }}?t=" + new Date().getTime();
            }, 100);
        }

        document.getElementById('stopBtn')?.addEventListener('click', async () => {
            await fetch('/stop_processing');
            location.reload();
        });

        {% if is_processing %}
        const checkProcessing = setInterval(async () => {
            const response = await fetch('/');
            const text = await response.text();
            if (!text.includes('–ò–¥—ë—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ')) {
                clearInterval(checkProcessing);
                location.reload();
            }
        }, 1000);
        {% endif %}
    </script>
</body>
</html>